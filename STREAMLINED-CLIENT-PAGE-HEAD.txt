import React, { useState, useRef } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Camera, FileText, ArrowLeft, Edit3, Download, X, Image as ImageIcon, DollarSign, Calendar, Wrench, Plus, Trash2, Calculator, Receipt as ReceiptIcon, MapPin, Navigation, ExternalLink, Upload } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent } from '@/components/ui/card';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';

import { generateMapsLink, generateDirectionsLink } from '@/lib/maps';
import { compressMultipleImages, formatFileSize } from '@/lib/imageCompression';
import type { Project, Photo, Receipt, ToolsChecklist, DailyHours } from '@shared/schema';
import InvoiceGenerator from './InvoiceGenerator';
import EstimateGenerator from './EstimateGenerator';
import PhotoCarousel from './PhotoCarousel';
import ErrorTooltip from './ui/error-tooltip';
import SuccessTooltip from './ui/success-tooltip';
import { useErrorTooltip } from '@/hooks/useErrorTooltip';
import { ReactSortable } from 'react-sortablejs';

// Calendar function for A-Frame calendar integration
const openWorkCalendar = (clientProject: Project | null = null) => {
  const aframeCalendarOnlyUrl = 'https://calendar.google.com/calendar/embed?src=6b990af5658408422c42677572f2ef19740096a1608165f15f59135db4f2a981%40group.calendar.google.com&ctz=America%2FVancouver&mode=WEEK&showTitle=1&showNav=1&showDate=1&showPrint=0&showTabs=1&showCalendars=0&showTz=0&bgcolor=%23000000&color=%23ffffff';
  
  if (clientProject) {
    const eventTitle = `${clientProject.clientName} - ${clientProject.projectType}`;
    const eventLocation = `${clientProject.address}, ${clientProject.clientCity || ''}`;
    
    const createEventUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventTitle)}&location=${encodeURIComponent(eventLocation)}&details=${encodeURIComponent(`Client: ${clientProject.clientName}\nProject: ${clientProject.projectType}`)}&cid=6b990af5658408422c42677572f2ef19740096a1608165f15f59135db4f2a981@group.calendar.google.com`;
    
    window.open(createEventUrl, '_blank');
  } else {
    // Open ONLY the A-Frame work calendar (isolated view with dark mode)
    // This direct URL shows just the A-Frame calendar without your other calendars
    const workCalendarDirectUrl = 'https://calendar.google.com/calendar/u/0?cid=NmI5OTBhZjU2NTg0MDg0MjJjNDI2Nzc1NzJmMmVmMTk3NDAwOTZhMTYwODE2NWYxNWY1OTEzNWRiNGYyYTk4MUBncm91cC5jYWxlbmRhci5nb29nbGUuY29t&color=%23039BE5&bgcolor=%23000000';
    window.open(workCalendarDirectUrl, '_blank');
  }
};

// Improved file list component
function SimpleFilesList({ projectId }: { projectId: number }) {
  const queryClient = useQueryClient();
  const [editingReceipt, setEditingReceipt] = useState<Receipt | null>(null);
  const [editVendor, setEditVendor] = useState('');
  const [editAmount, setEditAmount] = useState('');
  const [editDescription, setEditDescription] = useState('');

  const { data: receipts = [], isLoading, error } = useQuery<Receipt[]>({
    queryKey: [`/api/projects/${projectId}/receipts`],
  });
